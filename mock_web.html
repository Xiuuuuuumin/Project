<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>WebSocket æ¸¬è©¦é </title>
</head>
<body>
    <h1>WebSocket æ¸¬è©¦</h1>

    <label>Client Type:
        <select id="clientType">
            <option value="ros">ROS</option>
            <option value="flutter">Flutter</option>
            <option value="web" selected>Web</option>
        </select>
    </label>
    <button onclick="connectWS()">Connect</button>
    <br><br>

    <textarea id="log" cols="80" rows="20" readonly></textarea>
    <br>
    <input type="text" id="msgInput" placeholder="è¼¸å…¥è¨Šæ¯">
    <button onclick="sendMsg()">Send</button>

    <script>
        let ws;
        const log = document.getElementById("log");
        const TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxIiwicm9sZSI6InVzZXIiLCJleHAiOjE3NjA5NTczNzJ9.GdcnycNoaU01l8WMEJ6DX_g4DbW6zMcXTSpuTm2wBXQ";

        function appendLog(msg) {
            log.value += msg + "\n";
            log.scrollTop = log.scrollHeight;
        }

        function connectWS() {
            const clientType = document.getElementById("clientType").value;
            const url = `wss://635d713dea3a.ngrok-free.app/ws?client_type=${clientType}`;
            ws = new WebSocket(url);

            ws.onopen = () => {
                appendLog(`âœ… å·²é€£ç·š (${clientType})`);

                // ç¬¬ä¸€æ¬¡è¨Šæ¯ï¼šèªè­‰
                if (clientType === "web") {
                    ws.send(JSON.stringify({ token: TOKEN }));
                    appendLog("â¡ï¸ å·²é€å‡º Web èªè­‰ token");
                } else if (clientType === "flutter") {
                    ws.send(JSON.stringify({ token: TOKEN, user_id: 19 }));
                    appendLog("â¡ï¸ å·²é€å‡º Flutter èªè­‰ token + user_id");
                } else if (clientType === "ros") {
                    appendLog("â„¹ï¸ ROS ç„¡éœ€èªè­‰ï¼Œå¯ç›´æ¥å‚³é€è³‡æ–™");
                }
            };

            ws.onmessage = (event) => {
                appendLog(`ğŸ“¦ æ”¶åˆ°è¨Šæ¯: ${event.data}`);
            };

            ws.onclose = (event) => {
                appendLog(`âŒ é€£ç·šé—œé–‰ (code=${event.code}, reason=${event.reason})`);
            };

            ws.onerror = (err) => {
                appendLog(`âš ï¸ éŒ¯èª¤: ${err}`);
            };
        }

        function sendMsg() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                alert("WebSocket å°šæœªé€£ç·šï¼");
                return;
            }
            const msg = document.getElementById("msgInput").value;
            ws.send(msg);
            appendLog(`â¡ï¸ å‚³é€: ${msg}`);
            document.getElementById("msgInput").value = "";
        }
    </script>
</body>
</html>
